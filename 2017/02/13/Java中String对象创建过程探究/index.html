<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=7.0.1">


  <link rel="mask-icon" href="/favicon.ico?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="为了更好的理解 String 对象的创建过程，我们先来了解一下 Constant Pool 常量池的概念。在编译好的 Java class 文件中，有一个区域被称为 Constant Pool，它是一个由数组组成的表，类型为 cp_info constant_pool[]，用来存储程序中使用的各种常量，包括 Class、String、Integer 等各种基本的 Java 数据类型，其中， cp_">
<meta name="keywords" content="Java,String,intern,常量池,Constant Pool,String Pool">
<meta property="og:type" content="article">
<meta property="og:title" content="Java中String对象创建过程探究">
<meta property="og:url" content="https://www.huberylee.com/2017/02/13/Java中String对象创建过程探究/index.html">
<meta property="og:site_name" content="HuberyLee">
<meta property="og:description" content="为了更好的理解 String 对象的创建过程，我们先来了解一下 Constant Pool 常量池的概念。在编译好的 Java class 文件中，有一个区域被称为 Constant Pool，它是一个由数组组成的表，类型为 cp_info constant_pool[]，用来存储程序中使用的各种常量，包括 Class、String、Integer 等各种基本的 Java 数据类型，其中， cp_">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-01-07T02:54:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Java中String对象创建过程探究">
<meta name="twitter:description" content="为了更好的理解 String 对象的创建过程，我们先来了解一下 Constant Pool 常量池的概念。在编译好的 Java class 文件中，有一个区域被称为 Constant Pool，它是一个由数组组成的表，类型为 cp_info constant_pool[]，用来存储程序中使用的各种常量，包括 Class、String、Integer 等各种基本的 Java 数据类型，其中， cp_">






  <link rel="canonical" href="https://www.huberylee.com/2017/02/13/Java中String对象创建过程探究/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Java中String对象创建过程探究 | HuberyLee</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">HuberyLee</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    

    

    <a href="/" rel="section">首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    

    

    <a href="/archives/" rel="section">归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-photography">

    
    
    

    

    <a href="https://huberylee.tuchong.com" rel="noopener" target="_blank">摄影</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    

    

    <a href="/about/" rel="section">关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.huberylee.com/2017/02/13/Java中String对象创建过程探究/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="HuberyLee">
      <meta itemprop="description" content="玩得酷，靠得住，有梦想，爱学习的实力派！">
      <meta itemprop="image" content="/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HuberyLee">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Java中String对象创建过程探究

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2017-02-13 22:36:37" itemprop="dateCreated datePublished" datetime="2017-02-13T22:36:37+08:00">2017-02-13</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/" itemprop="url" rel="index"><span itemprop="name">开发</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/开发/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          
            <span id="/2017/02/13/Java中String对象创建过程探究/" class="leancloud_visitors" data-flag-title="Java中String对象创建过程探究">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">阅读次数：</span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>为了更好的理解 String 对象的创建过程，我们先来了解一下 Constant Pool 常量池的概念。在编译好的 Java class 文件中，有一个区域被称为 Constant Pool，它是一个由数组组成的表，类型为 cp_info constant_pool[]，用来存储程序中使用的各种常量，包括 Class、String、Integer 等各种基本的 Java 数据类型，其中， cp_info 的通用结构如下：</p>
<a id="more"></a>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp_info &#123;</span><br><span class="line">    u1 tag;</span><br><span class="line">    u1 info[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tag 是一个数字，用来标记存储的常量类型（类似于8表示 String 类型， 5表示 Long 类型），info[] 会根据 tag 值的不同而发生变化。在 Constant Pool 中用来存放 String 常量的区域被称为 String Pool，对于值相同的 String 常量，在 Constant Pool 中只会创建一个。程序执行时，Constant Pool 会存储在 Method Area 中，而不是堆中。另外，对于内容为空的字符串常量，也会创建一个长度为0、内容为空的字符串存储在 Constant Pool 中，并且 Constant Pool 可以在程序运行期间被动态扩展。</p>
<p>在了解 Constant Pool 基本情况后，接下来我们再来看看 String。在 Java 中，String 使用 private final char value[] 来实现字符串的存储，这也就是为什么我们说 String 对象在创建后其内容就不可再更改的原因！Java 中，String 对象的创建方式有很多种：</p>
<figure class="highlight java"><figcaption><span>示例1</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String strA = <span class="string">"a"</span>;</span><br><span class="line">String strB = <span class="keyword">new</span> String();</span><br><span class="line">String strC = <span class="keyword">new</span> String(<span class="string">"c"</span>);</span><br><span class="line">String strD = strA + strC; </span><br></pre></td></tr></table></figure>
<p>不同的创建方式会有不同的创建过程：当执行 String strA = “a” 时，JVM 首先会到 String Pool 中查找是否存在字符串对象 “a”，如果存在，则将该对象引用返回给 strA；如果不存在，JVM 会在 String Pool 中创建该字符串对象，并将其引用返回给 strA。值得注意的是，对于使用 “” 创建的字符串对象，其在编译期间就已经被创建并存储在 Constant Pool 中的 String Pool 中，通过下面这个例子，我们可以验证这一过程：</p>
<figure class="highlight java"><figcaption><span>示例2</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String strA = <span class="string">"a"</span>;</span><br><span class="line">String strB = <span class="string">"a"</span>;</span><br><span class="line">System.out.println(strA == strB);   <span class="comment">// output: true</span></span><br></pre></td></tr></table></figure>
<p>而对于 String strC = new String(“c”)，在执行时，JVM 首先会查看 String Pool 中是否存在字符串对象 “c”，若不存在，则在 String Pool 中创建字符串对象 “c”，然后执行 String(“c”) 构造函数在堆（heap）中创建一个字符串对象，并将堆（heap）中该对象引用返回给 strC；若存在，则直接使用 String Pool 中的字符串对象 “c”，然后调用 String(c””) 构造函数在堆（heap）中创建一个字符串对象，并将堆（heap）中该对象引用返回给 strC，所以，无论 String Pool 中是否存在 “c” 字符串对象， new String(“c”) 都会在堆（heap）中创建一个新的字符串对象，并且，如果 String Pool 中不存在字符串对象 “c” 时，使用 new String(“c”) 创建一个 String 对象时会创建两个字符串对象，一个在 String Pool 中（编译期），一个在堆中（运行期）:</p>
<figure class="highlight java"><figcaption><span>示例3</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String strA = <span class="keyword">new</span> String(<span class="string">"a"</span>);</span><br><span class="line">String strB = <span class="keyword">new</span> String(<span class="string">"a"</span>);</span><br><span class="line">System.out.println(strA == strB);       <span class="comment">// output: false</span></span><br><span class="line">System.out.println(strA.equals(strB));  <span class="comment">// output: true</span></span><br></pre></td></tr></table></figure>
<p><strong> 注意：对于 String 来讲，== 判断两个变量是否指向同一内存地址；equals() 判断两个对象是否“一样”（所有成员的值相同）。</strong></p>
<figure class="highlight java"><figcaption><span>示例4</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String strA = <span class="string">"a"</span> + <span class="string">"b"</span>;</span><br><span class="line">String strB = <span class="string">"ab"</span>;</span><br><span class="line">System.out.println(strA == strB);   <span class="comment">// output: true</span></span><br></pre></td></tr></table></figure>
<p>对于 示例4 的结果我们根据对 示例2 的分析可知， strA 在编译期就被优化为 ab，对此，我们可以假设 <strong><em> 对于使用 + 号链接的字符串常量，JVM在编译期间就将其优化为连接后的字符串常量 </em></strong>，下面我们来验证一下这个假设：</p>
<figure class="highlight java"><figcaption><span>示例5</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String strA = <span class="string">"a"</span> + <span class="string">"b"</span> + <span class="string">"c"</span>;</span><br><span class="line">String strB = <span class="string">"ab"</span> + <span class="string">"c"</span>;</span><br><span class="line">String strC = <span class="string">"abc"</span>;</span><br><span class="line">System.out.println(strA == strB);   <span class="comment">// output: true</span></span><br><span class="line">System.out.println(strA == strC);   <span class="comment">// output: true</span></span><br><span class="line">System.out.println(strB == strC);   <span class="comment">// output: true</span></span><br></pre></td></tr></table></figure>
<p>可见，<strong> 对于使用 + 号链接的字符串常量，JVM 在编译期间就将其优化为连接后的字符串常量，存储在 String Pool 中。 </strong> 那么，对于使用 + 号连接的字符串常量和变量是否有相同的处理方式呢？</p>
<figure class="highlight java"><figcaption><span>示例6</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String strA = <span class="string">"a"</span>;</span><br><span class="line">        String strB = <span class="string">"b"</span>;</span><br><span class="line">        String strC = <span class="string">"a"</span> + <span class="string">"b"</span>;</span><br><span class="line">        String strD = <span class="string">"a"</span> + strB;</span><br><span class="line">        String strE = strA + strB;</span><br><span class="line"></span><br><span class="line">        System.out.println(strC == strD);         <span class="comment">// output: false</span></span><br><span class="line">        System.out.println(strC.equals(strD));    <span class="comment">// output: true</span></span><br><span class="line">        System.out.println(strC == strE);         <span class="comment">// output: false</span></span><br><span class="line">        System.out.println(strC.equals(strE));    <span class="comment">// output: true</span></span><br><span class="line">        System.out.println(strD == strE);         <span class="comment">// output: false</span></span><br><span class="line">        System.out.println(strD.equals(strE));    <span class="comment">// output: true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由此可见，只要 + 号一边存在变量，编译期间就不会被优化，而变量的值只能在运行时才被确定，通过查看反编译后的字节码更可以确信这一点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">Compiled from <span class="string">"Test.java"</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       0: ldc           #2                  // String a</span><br><span class="line">       <span class="number">2</span>: astore_1</span><br><span class="line">       3: ldc           #3                  // String b</span><br><span class="line">       <span class="number">5</span>: astore_2</span><br><span class="line">       6: ldc           #4                  // String ab</span><br><span class="line">       <span class="number">8</span>: astore_3</span><br><span class="line">       9: new           #5                  // class java/lang/StringBuilder</span><br><span class="line">      <span class="number">12</span>: dup</span><br><span class="line">      13: invokespecial #6                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</span><br><span class="line">      16: ldc           #2                  // String a</span><br><span class="line">      18: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      <span class="number">21</span>: aload_2</span><br><span class="line">      22: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      25: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">      <span class="number">28</span>: astore        <span class="number">4</span></span><br><span class="line">      30: new           #5                  // class java/lang/StringBuilder</span><br><span class="line">      <span class="number">33</span>: dup</span><br><span class="line">      34: invokespecial #6                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</span><br><span class="line">      <span class="number">37</span>: aload_1</span><br><span class="line">      38: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      <span class="number">41</span>: aload_2</span><br><span class="line">      42: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      45: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">      <span class="number">48</span>: astore        <span class="number">5</span></span><br><span class="line">      50: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">53</span>: aload_3</span><br><span class="line">      <span class="number">54</span>: aload         <span class="number">4</span></span><br><span class="line">      <span class="number">56</span>: if_acmpne     <span class="number">63</span></span><br><span class="line">      <span class="number">59</span>: iconst_1</span><br><span class="line">      <span class="number">60</span>: goto          <span class="number">64</span></span><br><span class="line">      <span class="number">63</span>: iconst_0</span><br><span class="line">      64: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      67: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">70</span>: aload_3</span><br><span class="line">      <span class="number">71</span>: aload         <span class="number">4</span></span><br><span class="line">      73: invokevirtual #11                 // Method java/lang/String.equals:(Ljava/lang/Object;)Z</span><br><span class="line">      76: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      79: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">82</span>: aload_3</span><br><span class="line">      <span class="number">83</span>: aload         <span class="number">5</span></span><br><span class="line">      <span class="number">85</span>: if_acmpne     <span class="number">92</span></span><br><span class="line">      <span class="number">88</span>: iconst_1</span><br><span class="line">      <span class="number">89</span>: goto          <span class="number">93</span></span><br><span class="line">      <span class="number">92</span>: iconst_0</span><br><span class="line">      93: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      96: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">99</span>: aload_3</span><br><span class="line">     <span class="number">100</span>: aload         <span class="number">5</span></span><br><span class="line">     102: invokevirtual #11                 // Method java/lang/String.equals:(Ljava/lang/Object;)Z</span><br><span class="line">     105: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">     108: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">     <span class="number">111</span>: aload         <span class="number">4</span></span><br><span class="line">     <span class="number">113</span>: aload         <span class="number">5</span></span><br><span class="line">     <span class="number">115</span>: if_acmpne     <span class="number">122</span></span><br><span class="line">     <span class="number">118</span>: iconst_1</span><br><span class="line">     <span class="number">119</span>: goto          <span class="number">123</span></span><br><span class="line">     <span class="number">122</span>: iconst_0</span><br><span class="line">     123: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">     126: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">     <span class="number">129</span>: aload         <span class="number">4</span></span><br><span class="line">     <span class="number">131</span>: aload         <span class="number">5</span></span><br><span class="line">     133: invokevirtual #11                 // Method java/lang/String.equals:(Ljava/lang/Object;)Z</span><br><span class="line">     136: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">     <span class="number">139</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>示例7</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String strA = <span class="string">"a"</span>;</span><br><span class="line">        <span class="keyword">final</span> String strB = <span class="string">"b"</span>;</span><br><span class="line">        String strC = <span class="string">"a"</span> + <span class="string">"b"</span>;</span><br><span class="line">        String strD = <span class="string">"a"</span> + strB;</span><br><span class="line">        String strE = strA + strB;</span><br><span class="line"></span><br><span class="line">        System.out.println(strC == strD);         <span class="comment">// output: true</span></span><br><span class="line">        System.out.println(strC.equals(strD));    <span class="comment">// output: true</span></span><br><span class="line">        System.out.println(strC == strE);         <span class="comment">// output: false</span></span><br><span class="line">        System.out.println(strC.equals(strE));    <span class="comment">// output: true</span></span><br><span class="line">        System.out.println(strD == strE);         <span class="comment">// output: false</span></span><br><span class="line">        System.out.println(strD.equals(strE));    <span class="comment">// output: true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例7 相比于 示例6，唯一的不同在于 strB 前添加了 final 关键字，被 final 关键字修饰的变量在编译期间会被当做一个常量处理，JVM 会对 final 修饰的变量、方法等在编译期间做一些内联处理，以提高性能。查看反编译后的字节码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Compiled from <span class="string">"Test.java"</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Test</span><span class="params">()</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       <span class="number">0</span>: aload_0</span><br><span class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</span><br><span class="line">       <span class="number">4</span>: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(java.lang.String[])</span></span>;</span><br><span class="line">    Code:</span><br><span class="line">       0: ldc           #2                  // String a</span><br><span class="line">       <span class="number">2</span>: astore_1</span><br><span class="line">       3: ldc           #3                  // String ab</span><br><span class="line">       <span class="number">5</span>: astore_3</span><br><span class="line">       6: ldc           #3                  // String ab</span><br><span class="line">       <span class="number">8</span>: astore        <span class="number">4</span></span><br><span class="line">      10: new           #4                  // class java/lang/StringBuilder</span><br><span class="line">      <span class="number">13</span>: dup</span><br><span class="line">      14: invokespecial #5                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</span><br><span class="line">      <span class="number">17</span>: aload_1</span><br><span class="line">      18: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      21: ldc           #7                  // String b</span><br><span class="line">      23: invokevirtual #6                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">      26: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">      <span class="number">29</span>: astore        <span class="number">5</span></span><br><span class="line">      31: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">34</span>: aload_3</span><br><span class="line">      <span class="number">35</span>: aload         <span class="number">4</span></span><br><span class="line">      <span class="number">37</span>: if_acmpne     <span class="number">44</span></span><br><span class="line">      <span class="number">40</span>: iconst_1</span><br><span class="line">      <span class="number">41</span>: goto          <span class="number">45</span></span><br><span class="line">      <span class="number">44</span>: iconst_0</span><br><span class="line">      45: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      48: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">51</span>: aload_3</span><br><span class="line">      <span class="number">52</span>: aload         <span class="number">4</span></span><br><span class="line">      54: invokevirtual #11                 // Method java/lang/String.equals:(Ljava/lang/Object;)Z</span><br><span class="line">      57: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      60: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">63</span>: aload_3</span><br><span class="line">      <span class="number">64</span>: aload         <span class="number">5</span></span><br><span class="line">      <span class="number">66</span>: if_acmpne     <span class="number">73</span></span><br><span class="line">      <span class="number">69</span>: iconst_1</span><br><span class="line">      <span class="number">70</span>: goto          <span class="number">74</span></span><br><span class="line">      <span class="number">73</span>: iconst_0</span><br><span class="line">      74: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      77: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">80</span>: aload_3</span><br><span class="line">      <span class="number">81</span>: aload         <span class="number">5</span></span><br><span class="line">      83: invokevirtual #11                 // Method java/lang/String.equals:(Ljava/lang/Object;)Z</span><br><span class="line">      86: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">      89: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">      <span class="number">92</span>: aload         <span class="number">4</span></span><br><span class="line">      <span class="number">94</span>: aload         <span class="number">5</span></span><br><span class="line">      <span class="number">96</span>: if_acmpne     <span class="number">103</span></span><br><span class="line">      <span class="number">99</span>: iconst_1</span><br><span class="line">     <span class="number">100</span>: goto          <span class="number">104</span></span><br><span class="line">     <span class="number">103</span>: iconst_0</span><br><span class="line">     104: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">     107: getstatic     #9                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">     <span class="number">110</span>: aload         <span class="number">4</span></span><br><span class="line">     <span class="number">112</span>: aload         <span class="number">5</span></span><br><span class="line">     114: invokevirtual #11                 // Method java/lang/String.equals:(Ljava/lang/Object;)Z</span><br><span class="line">     117: invokevirtual #10                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">     <span class="number">120</span>: <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对比源代码第9行和反编译后的字节码第0-8行和第31-45行，我们会发现在编译期间， strD 就被优化为字符串常量 ab 存储在 String Pool 中，并且可以很明显的看到，对于字符串常量与变量的 + 操作是通过 StringBuilder.append() 方法完成的。</p>
<p>接下来我们来看看 intern() 方法，JDK8 文档中的描述如下：</p>
<blockquote><p><strong>public String intern()</strong><br>Returns a canonical representation for the string object.<br>A pool of strings, initially empty, is maintained privately by the class String.</p>
<p>When the intern method is invoked, if the pool already contains a string equal to this String object as determined by the equals(Object) method, then the string from the pool is returned. Otherwise, this String object is added to the pool and a reference to this String object is returned.</p>
<p>It follows that for any two strings s and t, s.intern() == t.intern() is true if and only if s.equals(t) is true.</p>
<p>All literal strings and string-valued constant expressions are interned. String literals are defined in section 3.10.5 of the The Java™ Language Specification.</p>
<p><strong>Returns:</strong><br>a string that has the same contents as this string, but is guaranteed to be from a pool of unique strings.</p>
</blockquote>
<p>简单来说，对一个 String 对象调用 intern() 方法时，JVM 首先会检查 String Pool 中是否存在与该对象值相等的对象（采用 equals() 方法），如果存在，则返回 String Pool 中该对象的引用；如果不存在，则先在 String Pool 中创建一个相同值的 String 对象，然后返回其引用。下面我们来看一个例子：</p>
<figure class="highlight java"><figcaption><span>示例8</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String strA = <span class="string">"a"</span>;</span><br><span class="line">        String strB = <span class="keyword">new</span> String(<span class="string">"a"</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(strA == strB);   <span class="comment">// output: false</span></span><br><span class="line"></span><br><span class="line">        strB = strB.intern();</span><br><span class="line">        System.out.println(strA == strB);   <span class="comment">// output: true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然，”” 创建的字符串和 new String() 构造函数创建的字符串对象虽然值一样，但并不是同一个对象，通过对 new String() 构造函数创建的字符串调用 intern() 方法后，两个对象都指向 String Pool 中的 a 字符串对象。</p>
<p>下面来看一下美团点评技术团队 <a href="http://tech.meituan.com/in_depth_understanding_string_intern.html" target="_blank" rel="noopener">深入解析String#intern</a> 一文中的两个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String strA = <span class="keyword">new</span> String(<span class="string">"a"</span>) + <span class="keyword">new</span> String(<span class="string">"a"</span>);</span><br><span class="line">        strA.intern();</span><br><span class="line">        String strB = <span class="string">"aa"</span>;</span><br><span class="line"></span><br><span class="line">        System.out.println(strA == strB);   <span class="comment">// output: true</span></span><br><span class="line"></span><br><span class="line">        String strC = <span class="keyword">new</span> String(<span class="string">"b"</span>) + <span class="keyword">new</span> String(<span class="string">"b"</span>);</span><br><span class="line">        String strD = <span class="string">"bb"</span>;</span><br><span class="line">        strC.intern();</span><br><span class="line"></span><br><span class="line">        System.out.println(strC == strD);   <span class="comment">// output: false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可能乍一看，你会觉得，怎么用上面的理论解释不清呢，其实并不是，intern() 的运行机制没有变，只是在这里我们并没有将 intern() 函数的返回值赋给原对象，为弄清楚具体过程，你得了解 JVM 关于 Constant Pool 的存放位置，这里不再赘述，请移步 <a href="http://tech.meituan.com/in_depth_understanding_string_intern.html" target="_blank" rel="noopener">深入解析String#intern</a> “二，jdk6 和 jdk7 下 intern 的区别” 这部分查看详情。</p>
<p><strong> 参考： </strong></p>
<ul>
<li><a href="http://tech.meituan.com/in_depth_understanding_string_intern.html" target="_blank" rel="noopener">深入解析String#intern</a></li>
<li><a href="http://supportopensource.iteye.com/blog/770020" target="_blank" rel="noopener">创建String对象过程的内存分配小结</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Java/" rel="tag"># Java</a>
          
            <a href="/tags/String/" rel="tag"># String</a>
          
            <a href="/tags/intern/" rel="tag"># intern</a>
          
            <a href="/tags/常量池/" rel="tag"># 常量池</a>
          
            <a href="/tags/Constant-Pool/" rel="tag"># Constant Pool</a>
          
            <a href="/tags/String-Pool/" rel="tag"># String Pool</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/07/Java中间缓存变量机制/" rel="next" title="Java中间缓存变量机制">
                <i class="fa fa-chevron-left"></i> Java中间缓存变量机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/12/Java容器之HashMap实现原理/" rel="prev" title="Java容器之HashMap实现原理">
                Java容器之HashMap实现原理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/avatar.jpg" alt="HuberyLee">
            
              <p class="site-author-name" itemprop="name">HuberyLee</p>
              <div class="site-description motion-element" itemprop="description">玩得酷，靠得住，有梦想，爱学习的实力派！</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">55</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">124</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://idoubi.cc/" title="http://idoubi.cc/" rel="noopener" target="_blank">艾逗笔</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://chambakari.cn/" title="http://chambakari.cn/" rel="noopener" target="_blank">Bakari's Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.csdn.net/cloud_xiaobai" title="http://blog.csdn.net/cloud_xiaobai" rel="noopener" target="_blank">大帅哥的博客</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HuberyLee</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  
  
  <script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text('Counter not initialized! More info at console err msg.');
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + '3fYbb2sl0ejTHebEh35beUUF-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': '3fYbb2sl0ejTHebEh35beUUF-gzGzoHsz',
                'X-LC-Key': 'a4WT2UMeXclsnQomVwfGIYGJ',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script>



  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
